name: Setup branch protection

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Protect default branch
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          BRANCH=$(gh api "repos/$OWNER/$REPO" -q .default_branch)
          gh api -X PUT "repos/$OWNER/$REPO/branches/$BRANCH/protection" --input - <<EOF
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["pr-verify"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1
            },
            "restrictions": null,
            "required_linear_history": true,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "required_conversation_resolution": true
          }
          EOF