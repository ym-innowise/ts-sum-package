name: Setup branch protection

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Protect default branch
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO_FULL: ${{ github.repository }}
        run: |
          set -euo pipefail

          REQUIRED='["pr-verify"]'

          echo "Repo: $REPO_FULL"
          BRANCH=$(gh api "repos/$REPO_FULL" -q .default_branch)
          echo "Default branch: $BRANCH"

          cat > payload.json <<JSON
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ${REQUIRED}
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1
            },
            "required_linear_history": true,
            "required_conversation_resolution": true,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "restrictions": null
          }
          JSON

          gh api -X PUT "repos/$REPO_FULL/branches/$BRANCH/protection" --input payload.json